# TypeORM Test DB

## Overview

TypeORM Test DB wraps every Jest spec in an isolated database transaction. The helper accepts any initialized `DataSource`, replaces its manager during the spec, and restores the original manager after a rollback. The package targets reusable test setups that keep integration databases pristine.

## Features

- TypeORM test database lifecycle helper with explicit `init` and `finish` hooks.
- Framework-agnostic integration by invoking the lifecycle inside your test runner hooks.
- Compatibility with MySQL, MariaDB, PostgreSQL, SQLite, and Better SQLite 3.
- Deterministic data factories driven by a reproducible execution seed.
- Shared test setup that initializes one data source per worker and runs specs in parallel.
- Coverage reports generated by default through `pnpm test`.
- Build artifacts produced by `pnpm build` and consumed by the Jest suite to simulate an installed package.

## Installation

<details>
<summary>pnpm</summary>

```bash
pnpm add -D typeorm-test-db
pnpm add typeorm
```

</details>

<details>
<summary>npm</summary>

```bash
npm install -D typeorm-test-db
npm install typeorm
```

</details>

<details>
<summary>Yarn</summary>

```bash
yarn add -D typeorm-test-db
yarn add typeorm
```

</details>

Install TypeORM in the host project if it is not already available.

## Usage

Create a Jest setup file that initializes the data source and registers the TypeORM test database lifecycle.

```typescript
import { afterAll, afterEach, beforeAll, beforeEach } from "@jest/globals";
import { DataSource } from "typeorm";
import { TypeormTestDB } from "typeorm-test-db";

const dataSource = new DataSource({
  type: "mysql",
  host: "127.0.0.1",
  port: 3306,
  username: "root",
  password: "test",
  database: "test",
  synchronize: true,
  entities: [],
});

const lifecycle = TypeormTestDB(dataSource, {
  isolationLevel: "REPEATABLE READ",
});

beforeEach(async () => {
  await lifecycle.init();
});

afterEach(async () => {
  await lifecycle.finish();
});
```

Import your repositories or managers inside the specs. Every mutation executed between the registered hooks is rolled back automatically.

## Test Execution

The suite seeds reproducible fixtures per spec and exposes the `TEST_SEED` environment variable to control execution order. `pnpm test` runs Jest in parallel workers and enforces coverage collection.

## Continuous Integration

The GitHub Actions workflow lints the source code and runs the Jest suite against a matrix of transactional databases. A final aggregation job fails when any matrix job reports an error, which keeps the required status check stable even as new databases are added.

## Development

- `pnpm lint` checks code quality.
- `pnpm build` emits the production bundle under `dist`.
- `pnpm test` rebuilds the package, executes the seeded integration tests, and verifies the tarball can be installed in a clean project.

## License

TypeORM Test DB is available under the GNU General Public License v3.0 or later.
